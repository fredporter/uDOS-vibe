# v1.3.23 Adapter Lifecycle + Deterministic Replay Contract

Status: active/implemented for Core Stabilization Round A (2026-02-15)

## Scope

Round A stabilization requirements for:

- TOYBOX adapter lifecycle behavior (launch/stop/status/retry/health)
- deterministic replay of gameplay event streams

## Adapter Lifecycle Contract

### Required Operations

- `launch(adapter_id)`
- `stop(adapter_id)`
- `status(adapter_id)`
- `health(adapter_id)`

### Status Fields

Each adapter status payload must include:

- `adapter_id`
- `state` (`stopped`, `starting`, `running`, `degraded`, `failed`, `stopping`)
- `pid` (nullable)
- `retries`
- `last_error` (nullable)
- `last_transition_at`
- `health` (`ok`, `warn`, `fail`)

### Retry Policy (Round A Baseline)

- Max retries per launch attempt: `3`
- Backoff schedule: deterministic (`1s`, `2s`, `4s`)
- Transition to `failed` after final retry
- `status` must expose retry counters and final error summary

## Deterministic Replay Contract

### Input Artifact

- NDJSON event stream with ordered records:
  - `ts`, `source`, `username`, `type`, `payload`

### Replay Rules

- Replay consumes a fixed input file and starting state snapshot.
- Events are applied in file order only.
- Same input + same initial state => byte-identical output snapshot.
- Unknown event types are recorded in replay report and do not mutate state.

### Replay Output Artifacts

- `state_out.json` (post-replay gameplay state)
- `report.json` with:
  - `events_total`
  - `events_applied`
  - `events_skipped`
  - `unknown_event_types`
  - `checksum_before`
  - `checksum_after`

## Acceptance Tests

- lifecycle state-transition tests for all required operations
- retry exhaustion and health probe behavior tests
- replay determinism test (run twice, compare full output)
- replay unknown-event isolation test
