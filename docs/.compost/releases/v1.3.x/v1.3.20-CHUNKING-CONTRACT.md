# v1.3.20 Chunking Contract (2D Now, 3D Reserved)

Status: implemented (2026-02-15)

## Goal

Define a deterministic chunk key for the current 2D grid runtime while reserving
shape semantics for 3D adapters in later milestones.

## Canonical 2D Chunk ID

Format:

`<anchor>-<space>-<layer>-<col>`

Rules:
- `anchor`: lowercased anchor token (`:` converted to `-`)
- `space`: lowercased space token (`sur`, `sub`, `udn`, ...)
- `layer`: zero-padded effective layer (`300`-`899`)
- `col`: two-letter cell column from LocId cell (`AA`-`ZZ`, lowercased)

Examples:
- `EARTH:SUR:L300-BJ10` -> `earth-sur-300-bj`
- `EARTH:UDN:L306-AA10-Z2` -> `earth-udn-306-aa`
- `EARTH:SUB:L340-AA22-Z-3:D4` -> `earth-sub-340-aa`

## 3D Reservation

Current runtime still resolves movement and overlays in 2D chunk columns.
The chunk descriptor now reserves 3D metadata:

- `reserved3d.shape = extruded-column`
- `reserved3d.z = <current z>`

This avoids contract churn when v1.3.21 introduces z-aware chunk volumes.

## Runtime Surface

Python contract helper:
- `core/services/chunking_contract.py`
  - `parse_place_ref(place_ref)`
  - `derive_chunk2d_id(place_ref)`
  - `describe_chunk_shape(place_ref)`

Map runtime integration:
- `core/services/map_runtime_service.py`
  - status/action payloads now include `chunk2d_id`

## Compatibility

- Existing seed metadata chunk strings remain valid and continue to be honored.
- If metadata chunk is missing, runtime derives chunk id from PlaceRef.
