# v1.4.7 Completion Devlog

**Date:** 2026-02-24
**Milestone:** v1.4.7 Development Release — final pre-release polish

## Summary

All v1.4.7 exit criteria satisfied. 56 net-new tests across three new services, with the uHOME → Home Assistant bridge now fully wired end-to-end with real runtime handlers (not stubs).

---

## Features Completed

### 1. Cloud Provider Fallback Chain (`wizard/services/cloud_provider_executor.py`)

Multi-provider fallback replacing the previous Mistral-hardcoded OK mode:

- `run_cloud_with_fallback(prompt)` — iterates `[Mistral → OpenRouter → OpenAI → Anthropic → Gemini]` chain, respects `should_failover()` policy (auth/rate errors → failover; malformed prompt → break)
- `get_cloud_availability()` — inspects all providers for configured API keys; returns `{ready, available_providers, primary}`
- `_inject_context_into_request()` — per-style context injection: OpenAI/Mistral system message, Anthropic top-level `system` field, Gemini part prepend

**Updated callers:**
- `wizard/routes/ucode_routes.py` — `_run_ok_cloud` and `_ok_cloud_available` use executor
- `wizard/routes/ucode_ok_mode_utils.py` — `get_ok_cloud_status()` uses executor
- `core/services/ai_provider_handler.py` — `check_cloud_provider()` uses multi-provider chain

**Tests:** `wizard/tests/cloud_provider_executor_test.py` — 12 tests covering availability checks, fallback chain, context injection

---

### 2. Ollama Tier Service (`wizard/services/ollama_tier_service.py`)

Explicit hardware-tier model baselines extracted from `self_heal_routes.py`:

| Tier | Models |
|------|--------|
| tier1 | `mistral` |
| tier2 | `mistral`, `llama3.2`, `qwen3` |
| tier3 | `mistral`, `devstral-small-2`, `llama3.2`, `qwen3`, `codellama`, `phi3`, `gemma2`, `deepseek-coder` |

`get_tier_profile()` / `get_required_models()` / `detect_missing_models()` — all tag-agnostic (strips `:latest` etc.)

**Tests:** `wizard/tests/ollama_tier_service_test.py` — 22 tests covering tier baselines, profile resolution, fallback to DEFAULT_TIER, override parsing, tag normalization, missing model detection

---

### 3. Wizard Secret Sync Drift Repair

Two isolation bugs fixed that caused 2 config admin route tests to fail:

- **`wizard/services/admin_secret_contract.py`:** Added `use_live_config = repo_root is None` guard — when `repo_root` is explicitly passed (test mode), skip `get_config()` which reads live `.env`
- **`wizard/routes/config_admin_routes.py`:** Read `WIZARD_KEY` from `env_path` file first, then `os.environ.get()` (not `get_config()` which bypasses `monkeypatch.delenv`)

**Result:** All 9 wizard sync tests passing; `collect_admin_secret_contract` correctly detects drift in isolation

---

### 4. uHOME ↔ Home Assistant Bridge — Real Handlers

The bridge was previously route-complete (security, allowlist, discovery) but dispatched all `uhome.*` commands to a `_uhome_stub()`. This milestone wired real implementations.

#### New: `wizard/services/uhome_command_handlers.py`

**Tuner (HDHomeRun HTTP discovery):**
- `tuner_discover(params)` — probes LAN candidates (`HDHOMERUN_HOST` env → `hdhomerun.local` → `192.168.1.1`) via `http://{host}/discover.json`; returns `{devices_found, devices[{host, device_id, friendly_name, model, tuner_count, firmware, base_url}]}`
- `tuner_status(params)` — probes primary tuner; returns `{reachable, device_id, model, tuner_count}`

**DVR (JSON-backed schedule store):**
- Store: `memory/bank/uhome/dvr_schedule.json`
- `dvr_list_rules()` — returns all scheduled rules
- `dvr_schedule(params)` — creates rule with uuid4 id, validates `title` required
- `dvr_cancel(params)` — removes rule by id, reports `removed` count

**Ad Processing (Wizard config flag):**
- Config key: `uhome_ad_processing_mode`
- Valid modes: `disabled`, `comskip_auto`, `comskip_manual`, `passthrough`
- `ad_get_mode()` — reads from WizardConfig; defaults to `"disabled"`
- `ad_set_mode(params)` — validates mode, persists to WizardConfig

**Playback (Jellyfin HTTP probe):**
- `playback_status()` — probes `{JELLYFIN_URL}/Sessions?api_key={JELLYFIN_API_KEY}`; maps active sessions to `{user, title, media_type, client}`; graceful when not configured
- `playback_handoff(params)` — queues `{item_id, target_client}` entry to `memory/bank/uhome/playback_queue.json`

`dispatch(command, params)` — top-level dispatch table covering all 9 uHOME commands

#### Modified: `wizard/services/home_assistant_service.py`

`_uhome_stub()` → `_uhome_dispatch()` — calls `uhome_command_handlers.dispatch()`; graceful KeyError fallback for any future allowlisted command without a handler yet

#### Tests: `wizard/tests/home_assistant_routes_test.py` — 32 tests (was 10)

| Class | Tests | Coverage |
|-------|-------|----------|
| route guards (status/discover/command) | 10 | enabled/disabled, 503, 400, 422 |
| `TestUHomeTuner` | 4 | discover shape, device found, status reachable/unreachable |
| `TestUHomeDVR` | 7 | list empty, schedule+list, schedule missing title, cancel, cancel unknown, cancel missing id |
| `TestUHomeAdProcessing` | 5 | get default, valid modes list, set valid, set persists, set invalid |
| `TestUHomePlayback` | 6 | no jellyfin, jellyfin reachable+sessions, jellyfin unreachable, handoff queues, handoff missing id |

**All 32/32 passing.**

---

## Test Evidence

```
wizard/tests/ suite
  306 passed, 18 skipped, 1 pre-existing error (mcp.ClientSession import)
  home_assistant_routes_test.py: 32/32 ✅
  cloud_provider_executor_test.py: 12/12 ✅
  ollama_tier_service_test.py: 22/22 ✅
```

---

## Files Changed

**New:**
- `wizard/services/cloud_provider_executor.py`
- `wizard/services/ollama_tier_service.py`
- `wizard/services/uhome_command_handlers.py`
- `wizard/tests/cloud_provider_executor_test.py`
- `wizard/tests/ollama_tier_service_test.py`

**Modified:**
- `wizard/services/home_assistant_service.py` — `_uhome_stub` → `_uhome_dispatch`
- `wizard/services/admin_secret_contract.py` — test isolation fix
- `wizard/routes/config_admin_routes.py` — WIZARD_KEY env isolation fix
- `wizard/routes/ucode_routes.py` — executor integration
- `wizard/routes/ucode_ok_mode_utils.py` — executor integration
- `wizard/routes/self_heal_routes.py` — delegates to `ollama_tier_service`
- `core/services/ai_provider_handler.py` — multi-provider chain
- `wizard/tests/home_assistant_routes_test.py` — replaced stub test with 32 real tests
- `docs/roadmap.md` — v1.4.7 exit criteria closed

---

## v1.4.7 Exit Criteria — All Closed

- [x] Wizard secret store sync contract — drift detection + repair tested
- [x] Sonic schema drift eliminated — 3/3 contract tests pass
- [x] Cloud provider fallback chain — all 5 providers + 12 executor tests
- [x] Ollama tier-aware pulling stabilized — tier1/2/3 baselines + detect_missing_models
- [x] uHOME HA bridge routes live with integration tests — **32/32 passing**
- [x] Extended integration test coverage — 56 new tests this milestone
- [x] Devlog: this document
