# v1.4.7 Development Session — Progress Log

**Date:** 2026-02-24
**Milestone:** v1.4.7

---

## Overview

Resumed immediately after v1.4.6 completion. Audited all v1.4.7 exit criteria against
actual codebase before starting work. Found 5 of 6 items substantially implemented
but missing tests, service abstractions, or wiring. One item (HA bridge uHOME backend)
has routes/security complete but requires uHOME service integration.

---

## Work Completed

### 1. Cloud Provider Fallback Chain

**Problem:** `_run_ok_cloud` in Wizard was hardcoded to Mistral only despite
`cloud_provider_policy.py` having complete request/response/auth logic for all 5 providers.

**Solution:**
- Created `wizard/services/cloud_provider_executor.py`:
  - `run_cloud_with_fallback(prompt)` — tries providers in chain order, failover on
    auth errors / rate limits / timeouts
  - `get_cloud_availability()` — multi-provider status for `/ok/status` endpoint
  - `_inject_context_into_request()` — per-style context injection (OpenAI system message,
    Anthropic `system` field, Gemini part prepend)
- Updated `wizard/routes/ucode_routes.py` `_run_ok_cloud` to use executor
- Updated `wizard/routes/ucode_ok_mode_utils.py` `get_ok_cloud_status` to use executor
- Updated `core/services/ai_provider_handler.py` `check_cloud_provider()` to check all
  configured providers via `resolve_cloud_provider_chain()`
- Added `wizard/tests/cloud_provider_executor_test.py` — **12 tests, all passing**

**Provider chain:** Mistral → OpenRouter → OpenAI → Anthropic → Gemini
**Config:** `VIBE_CLOUD_PROVIDER_CHAIN` (comma-separated) or `VIBE_PRIMARY_CLOUD_PROVIDER`

---

### 2. Ollama Tier Service

**Problem:** `_required_ollama_models()` in `self_heal_routes.py` had tier3 hardcoded
as special-case and tier1/tier2 both using the same 4-model list (no distinction).

**Solution:**
- Created `wizard/services/ollama_tier_service.py`:
  - `TIER1_MODELS = ["mistral"]` — minimal footprint (Raspberry Pi tier)
  - `TIER2_MODELS = ["mistral", "llama3.2", "qwen3"]` — mid-range
  - `TIER3_MODELS` — full 8-model suite (unchanged from before)
  - `get_tier_profile(tier)` — returns `TierProfile` with models + default_model
  - `get_required_models(tier, override)` — respects `VIBE_OLLAMA_RECOMMENDED_MODELS` override
  - `detect_missing_models(required, running)` — tag-agnostic comparison
- Updated `self_heal_routes.py` to delegate to `get_required_models()`
- Added `wizard/tests/ollama_tier_service_test.py` — **22 tests, all passing**

---

### 3. Wizard Secret Sync — Drift Detection Fix

**Problem:** Two wizard sync/admin tests were failing due to test isolation issues.
`collect_admin_secret_contract()` and `generate_admin_token` both fell back to
`get_config("WIZARD_KEY")` which reads the live `.env` file even when a test provides
a `tmp_path` repo root.

**Fixes:**
- `wizard/services/admin_secret_contract.py`: When `repo_root` is explicitly provided,
  only read from that root's `.env` (no `get_config` fallback) — ensures test isolation
- `wizard/routes/config_admin_routes.py`: Read `WIZARD_KEY` from the resolved `env_path`
  first, then fall back to `os.environ` (not `get_config`) — respects `monkeypatch.delenv`

**Result:** 9/9 wizard sync/admin tests now passing

---

## Test Results

| Suite | Before | After |
|-------|--------|-------|
| Core | 662/663 | 662/663 (unchanged) |
| Wizard | 282/284 | **284/284** (2 failures fixed) |
| New tests added | — | +34 (executor: 12, tier: 22) |
| Handler tests | 113/113 | 113/113 (cloud check updated) |

---

## Files Created
- `wizard/services/cloud_provider_executor.py`
- `wizard/services/ollama_tier_service.py`
- `wizard/tests/cloud_provider_executor_test.py`
- `wizard/tests/ollama_tier_service_test.py`

## Files Modified
- `wizard/routes/ucode_routes.py` — `_run_ok_cloud` and `_ok_cloud_available` use executor
- `wizard/routes/ucode_ok_mode_utils.py` — `get_ok_cloud_status` uses executor
- `core/services/ai_provider_handler.py` — `check_cloud_provider()` multi-provider
- `wizard/services/admin_secret_contract.py` — test isolation fix for `repo_root`
- `wizard/routes/config_admin_routes.py` — WIZARD_KEY reads from `env_path` first
- `wizard/routes/self_heal_routes.py` — delegates to `ollama_tier_service`

---

## Remaining v1.4.7 Open Items

- **uHOME HA bridge backend wiring** — Routes and security model complete. Need to
  connect `home_assistant_service.py` command handlers to actual tuner/DVR/playback
  services rather than stub responses.
- **Devlog**: Final v1.4.7 completion summary (this file)
