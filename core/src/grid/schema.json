{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "UGRID Grid Canvas Input Schema",
  "description": "Schema for grid renderer input specifications",
  "type": "object",
  "definitions": {
    "GridCanvasSpec": {
      "type": "object",
      "required": ["width", "height"],
      "properties": {
        "width": { "const": 80, "type": "integer" },
        "height": { "const": 30, "type": "integer" },
        "title": { "type": "string", "maxLength": 70 },
        "theme": { "type": "string", "enum": ["mono", "dark", "light"] },
        "mode": {
          "type": "string",
          "enum": ["dashboard", "calendar", "schedule", "table", "map", "workflow"]
        },
        "ts": { "type": "string", "format": "date-time" }
      }
    },
    "TaskItem": {
      "type": "object",
      "required": ["status", "text"],
      "properties": {
        "id": { "type": "string" },
        "status": { "type": "string" },
        "text": { "type": "string" },
        "due": { "type": "string" },
        "owner": { "type": "string" },
        "placeRef": { "type": "string" },
        "locId": { "type": "string" },
        "location": { "type": "string" },
        "layer": { "type": "string" },
        "z": { "type": "integer" }
      }
    },
    "ScheduleItem": {
      "type": "object",
      "properties": {
        "id": { "type": "string" },
        "start": { "type": "string" },
        "end": { "type": "string" },
        "time": { "type": "string" },
        "item": { "type": "string" },
        "title": { "type": "string" },
        "channel": { "type": "string" },
        "placeRef": { "type": "string" },
        "locId": { "type": "string" },
        "location": { "type": "string" },
        "layer": { "type": "string" },
        "z": { "type": "integer" }
      }
    },
    "WorkflowStep": {
      "type": "object",
      "required": ["id", "title", "state"],
      "properties": {
        "id": { "type": "string" },
        "title": { "type": "string" },
        "state": { "type": "string", "enum": ["todo", "in_progress", "blocked", "done"] },
        "owner": { "type": "string" },
        "dependsOn": {
          "type": "array",
          "items": { "type": "string" }
        },
        "placeRef": { "type": "string" },
        "locId": { "type": "string" },
        "location": { "type": "string" },
        "layer": { "type": "string" },
        "z": { "type": "integer" }
      }
    },
    "CalendarInput": {
      "type": "object",
      "properties": {
        "events": {
          "type": "array",
          "items": { "$ref": "#/definitions/ScheduleItem" }
        },
        "tasks": {
          "type": "array",
          "items": { "$ref": "#/definitions/TaskItem" }
        }
      }
    },
    "TableColumn": {
      "type": "object",
      "required": ["key", "title"],
      "properties": {
        "key": { "type": "string" },
        "title": { "type": "string" },
        "width": { "type": "integer", "minimum": 3, "maximum": 40 }
      }
    },
    "TableInput": {
      "type": "object",
      "properties": {
        "query": { "type": "string" },
        "columns": {
          "type": "array",
          "items": { "$ref": "#/definitions/TableColumn" },
          "minItems": 1,
          "maxItems": 10
        },
        "rows": {
          "type": "array",
          "items": { "type": "object" }
        },
        "page": { "type": "integer", "minimum": 1 },
        "perPage": { "type": "integer", "minimum": 1, "maximum": 100 }
      }
    },
    "ScheduleInput": {
      "type": "object",
      "properties": {
        "events": {
          "type": "array",
          "items": { "$ref": "#/definitions/ScheduleItem" }
        },
        "scheduleItems": {
          "type": "array",
          "items": { "$ref": "#/definitions/ScheduleItem" }
        },
        "filters": { "type": "object" }
      }
    },
    "LocIdOverlay": {
      "type": "object",
      "required": ["locId", "icon"],
      "properties": {
        "locId": {
          "type": "string",
          "pattern": "^[A-Z0-9]+:[A-Z0-9]+:L[0-9]{3}-[A-Z]{2}[0-9]{2}(-Z-?[0-9]{1,2})?$"
        },
        "icon": { "type": "string", "enum": ["T", "N", "E", "!", "*"] },
        "label": { "type": "string", "maxLength": 20 },
        "z": { "type": "integer" }
      }
    },
    "TerrainCell": {
      "type": "object",
      "required": ["locId", "glyph"],
      "properties": {
        "locId": { "type": "string" },
        "glyph": { "type": "string", "minLength": 1, "maxLength": 1 },
        "label": { "type": "string", "maxLength": 20 },
        "z": { "type": "integer" }
      }
    },
    "MapObject": {
      "type": "object",
      "required": ["locId", "sprite"],
      "properties": {
        "locId": { "type": "string" },
        "sprite": { "type": "string", "minLength": 1, "maxLength": 2 },
        "label": { "type": "string", "maxLength": 20 },
        "z": { "type": "integer" }
      }
    },
    "WorkflowMarker": {
      "type": "object",
      "required": ["locId", "stepId", "state"],
      "properties": {
        "locId": { "type": "string" },
        "stepId": { "type": "string" },
        "state": { "type": "string", "enum": ["todo", "in_progress", "blocked", "done"] },
        "title": { "type": "string", "maxLength": 30 },
        "z": { "type": "integer" }
      }
    },
    "MapLayerSpec": {
      "type": "object",
      "required": ["kind"],
      "properties": {
        "kind": { "type": "string", "enum": ["terrain", "objects", "overlays", "workflow"] },
        "label": { "type": "string", "maxLength": 20 },
        "visible": { "type": "boolean" }
      }
    },
    "MapInput": {
      "type": "object",
      "properties": {
        "focusLocId": { "type": "string", "pattern": "^[A-Z0-9]+:[A-Z0-9]+:L[0-9]{3}-[A-Z]{2}[0-9]{2}(-Z-?[0-9]{1,2})?$" },
        "overlays": {
          "type": "array",
          "items": { "$ref": "#/definitions/LocIdOverlay" }
        },
        "terrain": {
          "type": "array",
          "items": { "$ref": "#/definitions/TerrainCell" }
        },
        "objects": {
          "type": "array",
          "items": { "$ref": "#/definitions/MapObject" }
        },
        "workflowMarkers": {
          "type": "array",
          "items": { "$ref": "#/definitions/WorkflowMarker" }
        },
        "layers": {
          "type": "array",
          "items": { "$ref": "#/definitions/MapLayerSpec" },
          "description": "Ordered layer stack bottom-to-top. Defaults: terrain, objects, overlays, workflow."
        },
        "viewport": {
          "type": "object",
          "properties": {
            "zRange": { "type": "integer", "minimum": 0 }
          }
        }
      }
    },
    "DashboardInput": {
      "type": "object",
      "properties": {
        "missions": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "status": { "type": "string" },
              "title": { "type": "string" }
            }
          }
        },
        "stats": { "type": "object" },
        "apiQuota": {
          "type": "object",
          "properties": {
            "used": { "type": "integer" },
            "limit": { "type": "integer" }
          }
        },
        "nodeState": {
          "type": "object",
          "properties": {
            "status": { "type": "string" },
            "uptime": { "type": "string" }
          }
        },
        "logs": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "time": { "type": "string" },
              "level": { "type": "string", "enum": ["DEBUG", "INFO", "WARN", "ERROR"] },
              "message": { "type": "string" }
            }
          }
        },
        "tasks": {
          "type": "array",
          "items": { "$ref": "#/definitions/TaskItem" }
        },
        "scheduleItems": {
          "type": "array",
          "items": { "$ref": "#/definitions/ScheduleItem" }
        },
        "workflowSteps": {
          "type": "array",
          "items": { "$ref": "#/definitions/WorkflowStep" }
        }
      }
    },
    "WorkflowInput": {
      "type": "object",
      "properties": {
        "tasks": {
          "type": "array",
          "items": { "$ref": "#/definitions/TaskItem" }
        },
        "scheduleItems": {
          "type": "array",
          "items": { "$ref": "#/definitions/ScheduleItem" }
        },
        "workflowSteps": {
          "type": "array",
          "items": { "$ref": "#/definitions/WorkflowStep" }
        }
      }
    }
  },
  "allOf": [
    {
      "required": ["spec", "data", "mode"],
      "properties": {
        "spec": { "$ref": "#/definitions/GridCanvasSpec" },
        "mode": { "type": "string", "enum": ["calendar", "table", "schedule", "map", "dashboard", "workflow"] }
      }
    },
    {
      "oneOf": [
        {
          "properties": {
            "mode": { "const": "calendar" },
            "data": { "$ref": "#/definitions/CalendarInput" }
          }
        },
        {
          "properties": {
            "mode": { "const": "table" },
            "data": { "$ref": "#/definitions/TableInput" }
          }
        },
        {
          "properties": {
            "mode": { "const": "schedule" },
            "data": { "$ref": "#/definitions/ScheduleInput" }
          }
        },
        {
          "properties": {
            "mode": { "const": "map" },
            "data": { "$ref": "#/definitions/MapInput" }
          }
        },
        {
          "properties": {
            "mode": { "const": "dashboard" },
            "data": { "$ref": "#/definitions/DashboardInput" }
          }
        },
        {
          "properties": {
            "mode": { "const": "workflow" },
            "data": { "$ref": "#/definitions/WorkflowInput" }
          }
        }
      ]
    }
  ]
}
