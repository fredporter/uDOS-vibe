#!/bin/sh
# Alpine Linux Persistence Manager
# Handles UDOS_PERSIST partition mounting + apkovl configuration
#
# Strategy:
#  1. Dedicated UDOS_PERSIST partition (ext4) on media
#  2. Mounted at /mnt/udos during boot
#  3. apkovl overlays ephemeral root from /mnt/udos/apkovl/
#  4. GUI state, logs, user data stored in /mnt/udos/
#
# Usage: udos-persist {check|mount|unmount|setup|backup|restore}

set -e

PERSIST_MOUNT="/mnt/udos"
PERSIST_DEVICE="${PERSIST_DEVICE:-}"
PERSIST_LABEL="UDOS_PERSIST"
APKOVL_DIR="$PERSIST_MOUNT/apkovl"
BACKUP_DIR="$PERSIST_MOUNT/backups"
CHECK_INTERVAL=300  # Health check every 5 minutes

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

info() { echo "${BLUE}[INFO]${NC} $*"; }
success() { echo "${GREEN}[OK]${NC} $*"; }
warn() { echo "${YELLOW}[WARN]${NC} $*"; }
error() { echo "${RED}[ERROR]${NC} $*" >&2; }

# Find UDOS_PERSIST by label or device
find_persist_device() {
    # Try to find by label first
    PERSIST_DEVICE=$(blkid -L "$PERSIST_LABEL" 2>/dev/null || echo "")

    if [ -z "$PERSIST_DEVICE" ]; then
        # Fall back to environment variable
        if [ -n "${UDOS_PERSIST_DEVICE:-}" ]; then
            PERSIST_DEVICE="$UDOS_PERSIST_DEVICE"
        else
            error "Cannot find UDOS_PERSIST partition"
            error "Set UDOS_PERSIST_DEVICE or label device as '$PERSIST_LABEL'"
            return 1
        fi
    fi

    info "Found UDOS_PERSIST device: $PERSIST_DEVICE"
    return 0
}

# Check partition health
cmd_check() {
    info "Checking persistence partition..."

    if [ ! -d "$PERSIST_MOUNT" ]; then
        warn "Persistence mount point missing: $PERSIST_MOUNT"
        return 1
    fi

    if ! mountpoint -q "$PERSIST_MOUNT"; then
        warn "Persistence partition not mounted"
        return 1
    fi

    # Check available space
    local used=$(df "$PERSIST_MOUNT" | tail -1 | awk '{print $5}' | sed 's/%//')
    if [ "$used" -gt 90 ]; then
        warn "Persistence partition is $used% full"
    else
        success "Persistence partition at $used% capacity"
    fi

    # Check directory structure
    for dir in apkovl backups logs data etc/udos var/ui var/ui/config var/ui/cache var/ui/data var/ui/state; do
        if [ ! -d "$PERSIST_MOUNT/$dir" ]; then
            warn "Missing directory: $dir (creating)"
            mkdir -p "$PERSIST_MOUNT/$dir"
        fi
    done

    # Check apkovl readiness for Alpine
    if [ -d "$APKOVL_DIR" ]; then
        success "apkovl directory ready: $APKOVL_DIR"
    else
        info "apkovl directory not yet configured"
    fi

    success "Persistence check complete"
    return 0
}

# Mount persistence partition
cmd_mount() {
    info "Mounting persistence partition..."

    if mountpoint -q "$PERSIST_MOUNT"; then
        success "Persistence already mounted: $PERSIST_MOUNT"
        return 0
    fi

    find_persist_device || return 1

    # Ensure mount point exists
    mkdir -p "$PERSIST_MOUNT"

    # Mount read-write
    info "Mounting $PERSIST_DEVICE to $PERSIST_MOUNT..."
    if mount -t ext4 -o rw,noatime "$PERSIST_DEVICE" "$PERSIST_MOUNT"; then
        success "Persistence mounted: $PERSIST_MOUNT"
        cmd_check
        return 0
    else
        error "Failed to mount persistence partition"
        return 1
    fi
}

# Unmount persistence partition safely
cmd_unmount() {
    info "Unmounting persistence partition..."

    if ! mountpoint -q "$PERSIST_MOUNT"; then
        warn "Persistence not mounted"
        return 0
    fi

    # Attempt to sync and unmount
    if sync && umount "$PERSIST_MOUNT"; then
        success "Persistence unmounted"
        return 0
    else
        error "Failed to unmount (may be in use)"
        return 1
    fi
}

# Initialize persistence partition (format + structure)
cmd_setup() {
    info "Setting up persistence partition..."

    find_persist_device || return 1

    # Check if already initialized
    if cmd_check 2>/dev/null; then
        warn "Persistence partition appears already initialized"
        read -p "Re-format? (y/N) " -r
        if [ "$REPLY" != "y" ]; then
            return 0
        fi
    fi

    warn "About to format: $PERSIST_DEVICE"
    warn "All data will be lost!"
    read -p "Type 'YES' to continue: " -r
    if [ "$REPLY" != "YES" ]; then
        info "Aborted"
        return 0
    fi

    # Unmount if currently mounted
    cmd_unmount

    # Format as ext4
    info "Formatting $PERSIST_DEVICE as ext4..."
    if mkfs.ext4 -L "$PERSIST_LABEL" "$PERSIST_DEVICE"; then
        success "Formatted"
    else
        error "Format failed"
        return 1
    fi

    # Mount and create directory structure
    if cmd_mount; then
        info "Creating directory structure..."
        mkdir -p "$APKOVL_DIR" "$BACKUP_DIR" "$PERSIST_MOUNT/logs" "$PERSIST_MOUNT/data" \
            "$PERSIST_MOUNT/etc/udos" "$PERSIST_MOUNT/var/ui" \
            "$PERSIST_MOUNT/var/ui/config" "$PERSIST_MOUNT/var/ui/cache" \
            "$PERSIST_MOUNT/var/ui/data" "$PERSIST_MOUNT/var/ui/state"
        success "Persistence initialized"
        return 0
    else
        error "Failed to mount after format"
        return 1
    fi
}

# Create apkovl backup
cmd_backup() {
    info "Creating apkovl backup..."

    if [ ! -d "$PERSIST_MOUNT" ]; then
        error "Persistence not mounted"
        return 1
    fi

    mkdir -p "$BACKUP_DIR"

    local timestamp=$(date +%Y%m%d-%H%M%S)
    local backup_file="$BACKUP_DIR/apkovl-$timestamp.tar.gz"

    info "Backing up to: $backup_file"

    # Include system config files in apkovl
    if tar czf "$backup_file" \
        --exclude 'proc' --exclude 'sys' --exclude 'dev' --exclude 'run' \
        /etc /root/.config 2>/dev/null; then
        success "Backup created: $backup_file"
        return 0
    else
        error "Backup failed"
        return 1
    fi
}

# Restore apkovl backup
cmd_restore() {
    if [ -z "$1" ]; then
        error "Usage: udos-persist restore <backup_file>"
        ls -la "$BACKUP_DIR" 2>/dev/null || echo "No backups found"
        return 1
    fi

    local backup_file="$1"

    if [ ! -f "$backup_file" ]; then
        error "Backup file not found: $backup_file"
        return 1
    fi

    warn "About to restore: $backup_file"
    warn "Current /etc will be overwritten!"
    read -p "Type 'YES' to continue: " -r
    if [ "$REPLY" != "YES" ]; then
        info "Aborted"
        return 0
    fi

    info "Restoring..."
    if tar xzf "$backup_file" -C / 2>/dev/null; then
        success "Restore complete (reboot recommended)"
        return 0
    else
        error "Restore failed"
        return 1
    fi
}

# Show help
cmd_help() {
    cat <<'EOF'
udos-persist - Alpine Persistence Partition Manager

Usage:
  udos-persist check      Check partition health and readiness
  udos-persist mount      Mount UDOS_PERSIST partition
  udos-persist unmount    Unmount safely
  udos-persist bind       Bind persistent paths into rootfs
  udos-persist setup      Initialize new persistence partition (destructive)
  udos-persist backup     Create apkovl backup
  udos-persist restore <file>  Restore backup
  udos-persist help       This help message

Configuration:
  Mount point:    /mnt/udos
  Partition label: UDOS_PERSIST
  Custom device:  UDOS_PERSIST_DEVICE=/dev/sdXN

Directories:
  /mnt/udos/apkovl/    - Alpine overlay files (persistent across reboots)
  /mnt/udos/backups/   - System backups
  /mnt/udos/logs/      - Application logs
  /mnt/udos/data/      - User/application data
  /mnt/udos/etc/udos   - Persistent uDOS config (bind-mounted to /etc/udos)
  /mnt/udos/var/ui     - Persistent UI state (bind-mounted to /var/udos/ui)

ApkOVL Strategy:
  Alpine diskless mode stores persistent files in apkovl directory.
  On boot, files are overlayed from UDOS_PERSIST onto ephemeral root.

Examples:
  $ udos-persist check
  $ udos-persist mount
  $ udos-persist bind
  $ udos-persist backup
  $ udos-persist setup    # Format new device
EOF
}

# Bind persistent directories into rootfs
cmd_bind() {
    info "Binding persistent directories into rootfs..."

    if ! mountpoint -q "$PERSIST_MOUNT"; then
        error "Persistence is not mounted: $PERSIST_MOUNT"
        return 1
    fi

    mkdir -p "$PERSIST_MOUNT/etc/udos" "$PERSIST_MOUNT/logs" "$PERSIST_MOUNT/var/ui"
    mkdir -p /etc/udos /var/log/udos /var/udos/ui

    mountpoint -q /etc/udos || mount --bind "$PERSIST_MOUNT/etc/udos" /etc/udos
    mountpoint -q /var/log/udos || mount --bind "$PERSIST_MOUNT/logs" /var/log/udos
    mountpoint -q /var/udos/ui || mount --bind "$PERSIST_MOUNT/var/ui" /var/udos/ui

    success "Bind mounts ready"
    return 0
}

# Main entry point
case "${1:-check}" in
    check)
        cmd_check
        ;;
    mount)
        cmd_mount
        ;;
    unmount)
        cmd_unmount
        ;;
    bind)
        cmd_bind
        ;;
    setup)
        cmd_setup
        ;;
    backup)
        cmd_backup
        ;;
    restore)
        cmd_restore "${2:-}"
        ;;
    help|--help|-h)
        cmd_help
        ;;
    *)
        error "Unknown command: $1"
        cmd_help
        exit 1
        ;;
esac
