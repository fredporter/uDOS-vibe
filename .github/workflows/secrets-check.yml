name: Secrets Detection & .env Structure Check

on:
  push:
    branches: ["main", "develop"]
  pull_request:

jobs:
  detect-secrets:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: TruffleHog: Scan for exposed secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --only-verified --fail

      - name: Verify .env structure (if exists)
        run: |
          if [ ! -f .env ]; then
            echo "‚úÖ No .env file found (correct for git)"
            exit 0
          fi

          echo "‚ö†Ô∏è  Found .env file in repository. Checking for secrets..."

          # Patterns that should NOT be in .env
          FORBIDDEN_PATTERNS=(
            "^[[:space:]]*MISTRAL_API_KEY[[:space:]]*=[^[:space:]]"
            "^[[:space:]]*ANTHROPIC_API_KEY[[:space:]]*=[^[:space:]]"
            "^[[:space:]]*OPENAI_API_KEY[[:space:]]*=[^[:space:]]"
            "^[[:space:]]*GITHUB_TOKEN[[:space:]]*=[^[:space:]]"
            "^[[:space:]]*AWS_SECRET_ACCESS_KEY[[:space:]]*=[^[:space:]]"
            "^[[:space:]]*WIZARD_ADMIN_TOKEN[[:space:]]*=[^[:space:]]"
            "^[[:space:]]*GCP_SERVICE_ACCOUNT[[:space:]]*=[^[:space:]]"
            "^[[:space:]]*AZURE_.*_KEY[[:space:]]*=[^[:space:]]"
          )

          FOUND_SECRETS=0
          for PATTERN in "${FORBIDDEN_PATTERNS[@]}"; do
            if grep -E "$PATTERN" .env 2>/dev/null; then
              echo "‚ùå ERROR: Found potential secret in .env matching: $PATTERN"
              FOUND_SECRETS=$((FOUND_SECRETS + 1))
            fi
          done

          if [ $FOUND_SECRETS -gt 0 ]; then
            echo ""
            echo "üîê Security Policy Violation:"
            echo "  API keys and tokens MUST NOT be in .env"
            echo "  They belong in wizard/secrets.tomb (encrypted)"
            echo ""
            echo "üí° To fix:"
            echo "  1. Remove all API keys from .env"
            echo "  2. Add them via Wizard dashboard: WIZARD start"
            echo "  3. Visit: http://localhost:8765/dashboard"
            echo "  4. Settings > Integrations > Add Secret"
            echo ""
            echo "üìñ See: docs/devlog/2026-02-24-security-audit.md"
            exit 1
          fi

          echo "‚úÖ .env structure check passed (no exposed secrets)"

      - name: Verify .env is in .gitignore
        run: |
          if [ -f .gitignore ]; then
            if grep -q "^\.env$" .gitignore || grep -q "^\.env$" .gitignore; then
              echo "‚úÖ .env is properly listed in .gitignore"
            else
              echo "‚ö†Ô∏è  .env may not be in .gitignore"
            fi
          fi
